Telegram бот конструктор цитат для Гражданского Общества

## Установка зависимостей и запуск

### В режиме Polling

Самый простой способ запустить бота - запустить в режиме Polling. Этот способ подходит для разработки, а также для работы на сервере.

_[Poetry](https://python-poetry.org/) должен быть установлен в ваш python интерпретатор._

1. Выполните:

    ```
    poetry install --no-root --no-dev
    ```

    Для разработчика:

    ```
    poetry install --no-root
    ```

1. Создайте файл .env в корне проекта. Запишите в файл параметры запуска: это токен бота и ID чата доступа

    ```
    TOKEN="Ваш токен Telegram"
    ```
    Токен telegram бота получите у BotFather.

1. Запустите бота:

    ```
    poetry run bot
    ```

1. Добавьте бота в чат, члены которого будут иметь доступ к боту. Затем в чате отправьте команду боту

    ```
    /chat_id@ИмяБота
    ```

1. Полученный идентификатор чата допишите в файл .env

    ```
    CHAT="Ваш идентификатор чата"
    ```

1. Добавьте шаблоны black.png и white.png 1920x1080 в папку quote_bot/templates

1. Перезапустите бота


## В режиме Serverless на AWS Lambda

1. Выпуск пакета
    1. Добавьте шаблоны black.png и white.png 1920x1080 в папку quote_bot/templates
    1. Вам понадобятся два архива - это сам проект бота и его зависимости. Пакет зависимостей собирается через [Docker](https://www.docker.com/) контейнер с linux от Amazon. Всё делается автоматически, вам нужно только запустить скрипт:

    ```
    sudo bash build_aws.sh
    ```

    root нужен для работы с Docker. Пакет Docker должен быть установлен, dockerd должен быть запущен.
    В результате работы скрипта появится архив aws.zip и aws-layer.zip

2. Разворачивание на Amazon

    1. Зарегистрируйте AWS Lambda и API Gateway по инструкции проекта https://github.com/DavisDmitry/aiogram-aws-serverless-example
    1. Зарегистрируйте WebHook на сервере Telegram по той же инструкции 
    1. Зарегистрируйте DynamoDB базу данных
    1. Дайте вашей lambda доступ к этой базе данных на чтение и запись
    1. Загрузите исходный код из архива aws.zip
    1. Создайте layer для runtimes python3.7 из архива aws-layer.zip
    1. Пропишите перенные окружения TOKEN и CHAT (как в файле .env из инструкции polling)

## Напутствие для разработчиков

1. Перед каждым commit запускайте make чтобы автоматически исправлять isort\flake8

    ```
    make
    ```

1. Не кладите большие объекты в FSMContext! В режиме polling используется MemoryStorage, который работает быстро, но 
при работе на AWS будет существенная задержка

1. Ваша Lambda должна быть быстрой. Если долго не отвечать Telegram серверу, он начнёт слать запросы повторно, что приведёт к ещё большей просадке по времени выполнения и странным багам

1. С точки зрения алгоритмов\математики самое сложное место - optimizator.py. Этот модуль отвечает за подбор оптимального размера шрифта и переносов строк, чтобы вместить текст в прямоугольную область. В ранних версиях использовалась SciPy минимизация функции двух аргументов (размер шрифта, максимальная длина строки) powell. Сейчас работает более простой алгоритм:
    * Методом бисекции (при фиксированном размере шрифта) ищется такой перенос строк, при котором соотношение сторон прямоугольника, в который укладывается текст, ближе всего к соотношению сторон заданного прямоугольника
    * Методом бисекции (при фиксированном переносе строк) ищется такой размер шрифта, чтобы шрифт не выходил за рамки прямоугольника

1. Poetry [не умеет](https://github.com/python-poetry/poetry/issues/1937) ставить пакеты в папку, как pip. Этот функицонал нужен для сборки aws-layout.zip. Поэтому тактика poetry -> pip -> aws-layout.zip. Poetry экспортирует свои зависимости в aws_requiremnents.txt автоматически при сборке aws-layout.zip